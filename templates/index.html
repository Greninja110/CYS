<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Traffic Analyzer</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
    <style>
        .gradient-bg {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
        }
        .file-upload {
            position: relative;
            display: inline-block;
            cursor: pointer;
        }
        .file-upload input[type=file] {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .pulse {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(66, 153, 225, 0.7);
            }
            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(66, 153, 225, 0);
            }
            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(66, 153, 225, 0);
            }
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 9999px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-queued {
            background-color: #edf2f7;
            color: #4a5568;
        }
        .status-processing {
            background-color: #ebf8ff;
            color: #2c5282;
        }
        .status-completed {
            background-color: #f0fff4;
            color: #22543d;
        }
        .status-failed {
            background-color: #fff5f5;
            color: #c53030;
        }
        .nav-link {
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: all 0.2s;
        }
        .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .nav-link.active {
            background-color: rgba(255, 255, 255, 0.2);
            font-weight: bold;
        }
        .dashboard-card {
            transition: all 0.3s;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .tooltip {
            position: relative;
            display: inline-block;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            padding: 5px;
            border-radius: 6px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        table tbody tr {
            transition: all 0.2s;
        }
        table tbody tr:hover {
            background-color: #edf2f7;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="bg-white p-8 rounded-lg shadow-lg text-center">
            <div class="flex justify-center">
                <svg class="animate-spin h-12 w-12 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
            <h3 class="mt-4 text-lg font-semibold text-gray-800">Analyzing Traffic</h3>
            <p class="mt-2 text-gray-600">Please wait while we analyze your network traffic...</p>
            <div class="mt-4">
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <p id="progressText" class="mt-2 text-sm text-gray-600">0%</p>
            </div>
        </div>
    </div>

    <!-- Main container -->
    <div class="flex flex-col h-screen">
        <!-- Header -->
        <header class="gradient-bg text-white shadow-lg">
            <div class="container mx-auto py-4 px-6 flex justify-between items-center">
                <div class="flex items-center">
                    <svg class="h-8 w-8 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <h1 class="text-2xl font-bold">Network Traffic Analyzer</h1>
                </div>
                <div>
                    <div id="modelStatus" class="text-sm">Checking model status...</div>
                </div>
            </div>
            <!-- Navigation -->
            <div class="container mx-auto px-6 py-2">
                <nav class="flex space-x-4">
                    <a class="nav-link active" data-target="upload">Upload</a>
                    <a class="nav-link" data-target="results">Results</a>
                    <a class="nav-link" data-target="history">History</a>
                    <a class="nav-link" data-target="about">About</a>
                </nav>
            </div>
        </header>

        <!-- Main content -->
        <main class="flex-grow container mx-auto px-6 py-8">
            <!-- Upload Section -->
            <section id="upload" class="page-section">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- File Upload Card -->
                    <div class="col-span-2 bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4">Upload Pcap File</h2>
                        <p class="text-gray-600 mb-6">Upload a network capture file (.pcap, .pcapng, or .cap) for analysis. Our AI model will analyze the traffic and identify potential threats.</p>
                        
                        <div class="border-dashed border-2 border-gray-300 rounded-lg p-8 text-center">
                            <div class="mb-4">
                                <svg class="mx-auto h-16 w-16 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                                </svg>
                            </div>
                            <p class="text-gray-600 mb-2">Drag and drop your file here, or</p>
                            <div class="file-upload">
                                <button class="pulse bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition duration-300">
                                    <i class="fas fa-upload mr-2"></i> Select File
                                </button>
                                <input type="file" id="fileInput" accept=".pcap,.pcapng,.cap" />
                            </div>
                            <p id="selectedFileName" class="mt-2 text-sm text-gray-500">No file selected</p>
                        </div>
                        
                        <div class="mt-6">
                            <button id="analyzeBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg disabled:opacity-50 disabled:cursor-not-allowed transition duration-300" disabled>
                                <i class="fas fa-chart-network mr-2"></i> Analyze Traffic
                            </button>
                        </div>
                    </div>
                    
                    <!-- Info Card -->
                    <div class="bg-white rounded-lg shadow-md p-6">
                        <h2 class="text-xl font-semibold mb-4">How It Works</h2>
                        <ul class="space-y-4">
                            <li class="flex items-start">
                                <div class="flex-shrink-0 h-6 w-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mr-3 mt-0.5">
                                    <span class="text-sm font-bold">1</span>
                                </div>
                                <p class="text-gray-600">Upload a PCAP file containing network traffic data.</p>
                            </li>
                            <li class="flex items-start">
                                <div class="flex-shrink-0 h-6 w-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mr-3 mt-0.5">
                                    <span class="text-sm font-bold">2</span>
                                </div>
                                <p class="text-gray-600">Our AI model extracts relevant features from the traffic data.</p>
                            </li>
                            <li class="flex items-start">
                                <div class="flex-shrink-0 h-6 w-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mr-3 mt-0.5">
                                    <span class="text-sm font-bold">3</span>
                                </div>
                                <p class="text-gray-600">The model analyzes patterns to detect malicious activities.</p>
                            </li>
                            <li class="flex items-start">
                                <div class="flex-shrink-0 h-6 w-6 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center mr-3 mt-0.5">
                                    <span class="text-sm font-bold">4</span>
                                </div>
                                <p class="text-gray-600">View detailed reports about normal traffic and detected attacks.</p>
                            </li>
                        </ul>
                        
                        <div class="mt-6 p-4 bg-yellow-50 rounded-lg border border-yellow-200">
                            <div class="flex items-start">
                                <div class="flex-shrink-0">
                                    <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                                    </svg>
                                </div>
                                <div class="ml-3">
                                    <h3 class="text-sm font-medium text-yellow-800">File Size Limit</h3>
                                    <div class="mt-1 text-sm text-yellow-700">
                                        <p>Maximum upload size is 500MB.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Results Section -->
            <section id="results" class="page-section hidden">
                <div id="resultContainer" class="hidden">
                    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h2 class="text-xl font-semibold">Analysis Results</h2>
                                <p id="resultFileName" class="text-gray-600 mt-1">filename.pcap</p>
                            </div>
                            <div id="resultStatusBadge" class="status-badge status-completed">Completed</div>
                        </div>
                        
                        <div id="resultSummary" class="mb-8">
                            <div class="flex flex-col md:flex-row gap-6">
                                <!-- Status Card -->
                                <div class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg p-6">
                                    <div class="flex justify-between items-center">
                                        <div>
                                            <p class="text-sm opacity-80">Traffic Status</p>
                                            <h3 id="trafficStatus" class="text-2xl font-bold mt-1">Normal</h3>
                                        </div>
                                        <div>
                                            <svg class="h-12 w-12 opacity-80" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                            </svg>
                                        </div>
                                    </div>
                                    <p id="statusDetails" class="mt-2 text-sm opacity-90">Traffic appears normal with no signs of attack.</p>
                                </div>
                                
                                <!-- Stats Card -->
                                <div class="flex-1 bg-gray-50 rounded-lg p-6">
                                    <h4 class="text-gray-500 text-sm font-medium">Traffic Statistics</h4>
                                    <div class="grid grid-cols-2 gap-4 mt-3">
                                        <div>
                                            <p class="text-sm text-gray-500">Flows Analyzed</p>
                                            <p id="flowsAnalyzed" class="text-xl font-bold text-gray-800 mt-1">1,252</p>
                                        </div>
                                        <div>
                                            <p class="text-sm text-gray-500">Normal Traffic</p>
                                            <p id="normalPercentage" class="text-xl font-bold text-gray-800 mt-1">98.5%</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Traffic Distribution Chart -->
                        <div class="mb-8">
                            <h3 class="text-lg font-semibold mb-4">Traffic Distribution</h3>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <canvas id="trafficDistributionChart" height="300"></canvas>
                            </div>
                        </div>
                        
                        <!-- Attack Types Table -->
                        <div>
                            <h3 class="text-lg font-semibold mb-4">Detected Traffic Types</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full bg-white">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Count</th>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Percentage</th>
                                            <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Confidence</th>
                                        </tr>
                                    </thead>
                                    <tbody id="attackTypesTable" class="divide-y divide-gray-200">
                                        <!-- Table rows will be inserted here dynamically -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="noResultsMessage" class="text-center py-16">
                    <svg class="mx-auto h-16 w-16 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <h3 class="mt-4 text-lg font-medium text-gray-900">No Results Yet</h3>
                    <p class="mt-1 text-gray-500">Upload a pcap file for analysis to see results here.</p>
                    <button id="goToUploadBtn" class="mt-6 bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-lg">
                        Go to Upload
                    </button>
                </div>
            </section>

            <!-- History Section -->
            <section id="history" class="page-section hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-semibold">Analysis History</h2>
                        <button id="clearHistoryBtn" class="text-sm text-red-600 hover:text-red-800">
                            <i class="fas fa-trash-alt mr-1"></i> Clear History
                        </button>
                    </div>
                    
                    <div id="historyTable" class="overflow-x-auto">
                        <table class="min-w-full">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">File Name</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="py-3 px-4 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200">
                                <!-- Table rows will be inserted here dynamically -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div id="emptyHistoryMessage" class="text-center py-12 hidden">
                        <svg class="mx-auto h-12 w-12 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        <h3 class="mt-2 text-sm font-medium text-gray-900">No analysis history</h3>
                        <p class="mt-1 text-sm text-gray-500">Upload a file to start analysis.</p>
                    </div>
                </div>
            </section>

            <!-- About Section -->
            <section id="about" class="page-section hidden">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-4">About Network Traffic Analyzer</h2>
                    
                    <div class="prose max-w-none">
                        <p class="text-gray-600">
                            The Network Traffic Analyzer is an advanced tool that uses artificial intelligence and machine learning to detect potential security threats in network traffic. Our system analyzes PCAP files to identify normal traffic patterns and various types of attacks.
                        </p>
                        
                        <h3 class="text-lg font-semibold mt-6 mb-2">How it Works</h3>
                        <p class="text-gray-600">
                            Our system employs a hybrid approach using autoencoder and classification models trained on multiple cybersecurity datasets including CICIDS2017, NSL-KDD, and UNSW-NB15. This approach allows for effective identification of various attack types such as:
                        </p>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-gray-800">DoS/DDoS Attacks</h4>
                                <p class="text-sm text-gray-600 mt-1">Attempts to make network resources unavailable by flooding them with traffic.</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-gray-800">Probe/Scan Attacks</h4>
                                <p class="text-sm text-gray-600 mt-1">Network scanning to gather information about potential vulnerabilities.</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-gray-800">R2L Attacks</h4>
                                <p class="text-sm text-gray-600 mt-1">Remote to Local attacks attempting to gain unauthorized access.</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg">
                                <h4 class="font-semibold text-gray-800">U2R Attacks</h4>
                                <p class="text-sm text-gray-600 mt-1">User to Root attacks attempting to escalate privileges.</p>
                            </div>
                        </div>
                        
                        <h3 class="text-lg font-semibold mt-6 mb-2">Dataset Information</h3>
                        <p class="text-gray-600">
                            Our model is trained on three major network security datasets:
                        </p>
                        
                        <ul class="list-disc pl-5 mt-2 space-y-2 text-gray-600">
                            <li><strong>CICIDS2017</strong>: Contains benign and the most up-to-date common attacks which resemble real-world data.</li>
                            <li><strong>NSL-KDD</strong>: A refined version of the KDD Cup 1999 dataset with duplicate records removed.</li>
                            <li><strong>UNSW-NB15</strong>: A hybrid of real modern normal activities and synthetic contemporary attack behaviors.</li>
                        </ul>
                        
                        <h3 class="text-lg font-semibold mt-6 mb-2">Technical Specifications</h3>
                        <p class="text-gray-600">
                            The Network Traffic Analyzer uses a combination of:
                        </p>
                        
                        <ul class="list-disc pl-5 mt-2 space-y-2 text-gray-600">
                            <li>Deep learning autoencoder for dimensionality reduction and anomaly detection</li>
                            <li>XGBoost classifier for attack type categorization</li>
                            <li>Feature engineering to extract relevant network traffic patterns</li>
                            <li>Flask web framework for the user interface</li>
                        </ul>
                    </div>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white py-4">
            <div class="container mx-auto px-6 text-center">
                <p>Network Traffic Analyzer &copy; 2025 | Powered by AI</p>
            </div>
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const fileInput = document.getElementById('fileInput');
            const selectedFileName = document.getElementById('selectedFileName');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const loadingOverlay = document.getElementById('loadingOverlay');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const navLinks = document.querySelectorAll('.nav-link');
            const pageSections = document.querySelectorAll('.page-section');
            const goToUploadBtn = document.getElementById('goToUploadBtn');
            const clearHistoryBtn = document.getElementById('clearHistoryBtn');
            const modelStatus = document.getElementById('modelStatus');
            
            // Result elements
            const resultContainer = document.getElementById('resultContainer');
            const noResultsMessage = document.getElementById('noResultsMessage');
            const resultFileName = document.getElementById('resultFileName');
            const resultStatusBadge = document.getElementById('resultStatusBadge');
            const trafficStatus = document.getElementById('trafficStatus');
            const statusDetails = document.getElementById('statusDetails');
            const flowsAnalyzed = document.getElementById('flowsAnalyzed');
            const normalPercentage = document.getElementById('normalPercentage');
            const attackTypesTable = document.getElementById('attackTypesTable');
            
            // Current task being analyzed
            let currentTaskId = null;
            let statusCheckInterval = null;
            let trafficChart = null;
            let attackColors = {
                'normal': 'rgba(72, 187, 120, 0.7)',
                'dos': 'rgba(237, 100, 100, 0.7)',
                'ddos': 'rgba(246, 173, 85, 0.7)',
                'probe': 'rgba(90, 103, 216, 0.7)',
                'r2l': 'rgba(153, 102, 255, 0.7)',
                'u2r': 'rgba(255, 159, 64, 0.7)',
                'backdoor': 'rgba(201, 91, 186, 0.7)',
                'injection': 'rgba(75, 192, 192, 0.7)',
                'mitm': 'rgba(255, 206, 86, 0.7)',
                'theft': 'rgba(54, 162, 235, 0.7)'
            };
            
            // Check model status
            checkModelStatus();
            
            // Load history
            loadHistory();
            
            // Set up event listeners
            fileInput.addEventListener('change', handleFileSelection);
            analyzeBtn.addEventListener('click', uploadAndAnalyze);
            goToUploadBtn.addEventListener('click', function() {
                showSection('upload');
            });
            clearHistoryBtn.addEventListener('click', clearHistory);
            
            // Navigation event listeners
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    const targetSection = this.getAttribute('data-target');
                    showSection(targetSection);
                });
            });
            
            // Functions
            function handleFileSelection() {
                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    selectedFileName.textContent = file.name;
                    analyzeBtn.disabled = false;
                } else {
                    selectedFileName.textContent = 'No file selected';
                    analyzeBtn.disabled = true;
                }
            }
            
            function uploadAndAnalyze() {
                const file = fileInput.files[0];
                if (!file) return;
                
                // Check file size
                if (file.size > 500 * 1024 * 1024) { // 500MB
                    alert('File size exceeds the maximum limit of 500MB.');
                    return;
                }
                
                // Check file extension
                const extension = file.name.split('.').pop().toLowerCase();
                if (!['pcap', 'pcapng', 'cap'].includes(extension)) {
                    alert('Invalid file format. Please upload a .pcap, .pcapng, or .cap file.');
                    return;
                }
                
                // Show loading overlay
                loadingOverlay.style.display = 'flex';
                progressBar.style.width = '0%';
                progressText.textContent = '0%';
                
                // Create form data
                const formData = new FormData();
                formData.append('file', file);
                
                // Upload file
                fetch('/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert('Upload failed: ' + data.error);
                        loadingOverlay.style.display = 'none';
                        return;
                    }
                    
                    // Start checking task status
                    currentTaskId = data.task_id;
                    checkTaskStatus(currentTaskId);
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred during upload.');
                    loadingOverlay.style.display = 'none';
                });
            }
            
            function checkTaskStatus(taskId) {
                // Clear previous interval if exists
                if (statusCheckInterval) {
                    clearInterval(statusCheckInterval);
                }
                
                // Set interval to check status
                statusCheckInterval = setInterval(() => {
                    fetch(`/status/${taskId}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.error) {
                                clearInterval(statusCheckInterval);
                                alert('Error checking task status: ' + data.error);
                                loadingOverlay.style.display = 'none';
                                return;
                            }
                            
                            // Update progress
                            progressBar.style.width = `${data.progress}%`;
                            progressText.textContent = `${data.progress}%`;
                            
                            // Check if task is completed or failed
                            if (data.status === 'completed' || data.status === 'failed') {
                                clearInterval(statusCheckInterval);
                                loadingOverlay.style.display = 'none';
                                
                                // Load result
                                loadResult(taskId);
                                
                                // Refresh history
                                loadHistory();
                            }
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            clearInterval(statusCheckInterval);
                            loadingOverlay.style.display = 'none';
                            alert('An error occurred while checking task status.');
                        });
                }, 1000);
            }
            
            function loadResult(taskId) {
                fetch(`/results/${taskId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            if (data.status !== 'completed') {
                                alert('Analysis not yet completed. Current status: ' + data.status);
                                return;
                            }
                            alert('Error loading results: ' + data.error);
                            return;
                        }
                        
                        // Display results
                        displayResult(data);
                        
                        // Switch to results tab
                        showSection('results');
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An error occurred while loading results.');
                    });
            }
            
            function displayResult(data) {
                // Show result container and hide no results message
                resultContainer.classList.remove('hidden');
                noResultsMessage.classList.add('hidden');
                
                // Set basic info
                resultFileName.textContent = data.filename;
                
                // Set status badge
                resultStatusBadge.className = 'status-badge status-' + data.status;
                resultStatusBadge.textContent = capitalizeFirstLetter(data.status);
                
                const result = data.result;
                
                // Check if result is available
                if (!result) {
                    trafficStatus.textContent = 'Analysis Failed';
                    statusDetails.textContent = 'Could not analyze the traffic data.';
                    return;
                }
                
                // Set traffic status
                trafficStatus.textContent = result.status;
                statusDetails.textContent = result.details;
                
                // Set traffic stats
                flowsAnalyzed.textContent = result.flows_analyzed.toLocaleString();
                normalPercentage.textContent = result.normal_percentage.toFixed(1) + '%';
                
                // Update status card color based on result
                const statusCard = trafficStatus.closest('.bg-gradient-to-r');
                if (result.status.toLowerCase().includes('normal')) {
                    statusCard.className = 'flex-1 bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg p-6';
                } else if (result.status.toLowerCase().includes('mostly')) {
                    statusCard.className = 'flex-1 bg-gradient-to-r from-yellow-500 to-yellow-600 text-white rounded-lg p-6';
                } else {
                    statusCard.className = 'flex-1 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-lg p-6';
                }
                
                // Clear attack types table
                attackTypesTable.innerHTML = '';
                
                // Populate attack types table and prepare chart data
                const chartLabels = [];
                const chartData = [];
                const chartColors = [];
                
                result.attack_types.forEach(attack => {
                    // Add to table
                    const row = document.createElement('tr');
                    
                    // Create label cell
                    const typeCell = document.createElement('td');
                    typeCell.className = 'py-3 px-4';
                    
                    // Create label with colored dot
                    const typeLabel = document.createElement('div');
                    typeLabel.className = 'flex items-center';
                    
                    const colorDot = document.createElement('span');
                    const color = attackColors[attack.type] || 'rgba(156, 163, 175, 0.7)';
                    colorDot.className = 'w-3 h-3 rounded-full mr-2';
                    colorDot.style.backgroundColor = color;
                    
                    const typeText = document.createTextNode(attack.type);
                    
                    typeLabel.appendChild(colorDot);
                    typeLabel.appendChild(typeText);
                    typeCell.appendChild(typeLabel);
                    
                    // Create description cell
                    const descCell = document.createElement('td');
                    descCell.className = 'py-3 px-4 text-gray-500';
                    descCell.textContent = attack.description;
                    
                    // Create count cell
                    const countCell = document.createElement('td');
                    countCell.className = 'py-3 px-4';
                    countCell.textContent = attack.count.toLocaleString();
                    
                    // Create percentage cell
                    const percentCell = document.createElement('td');
                    percentCell.className = 'py-3 px-4';
                    percentCell.textContent = attack.percentage.toFixed(1) + '%';
                    
                    // Create confidence cell
                    const confidenceCell = document.createElement('td');
                    confidenceCell.className = 'py-3 px-4';
                    
                    // Create confidence bar
                    const confidenceBar = document.createElement('div');
                    confidenceBar.className = 'w-full bg-gray-200 rounded-full h-2.5';
                    
                    const confidenceFill = document.createElement('div');
                    confidenceFill.className = 'h-2.5 rounded-full';
                    confidenceFill.style.width = attack.confidence.toFixed(1) + '%';
                    
                    // Set confidence bar color
                    if (attack.confidence >= 80) {
                        confidenceFill.className += ' bg-green-600';
                    } else if (attack.confidence >= 60) {
                        confidenceFill.className += ' bg-yellow-500';
                    } else {
                        confidenceFill.className += ' bg-red-500';
                    }
                    
                    confidenceBar.appendChild(confidenceFill);
                    
                    // Create confidence text
                    const confidenceText = document.createElement('p');
                    confidenceText.className = 'text-xs text-gray-500 mt-1';
                    confidenceText.textContent = attack.confidence.toFixed(1) + '%';
                    
                    confidenceCell.appendChild(confidenceBar);
                    confidenceCell.appendChild(confidenceText);
                    
                    // Add cells to row
                    row.appendChild(typeCell);
                    row.appendChild(descCell);
                    row.appendChild(countCell);
                    row.appendChild(percentCell);
                    row.appendChild(confidenceCell);
                    
                    // Add row to table
                    attackTypesTable.appendChild(row);
                    
                    // Add to chart data
                    chartLabels.push(attack.type);
                    chartData.push(attack.percentage);
                    chartColors.push(color);
                });
                
                // Create chart
                createTrafficChart(chartLabels, chartData, chartColors);
            }
            
            function createTrafficChart(labels, data, colors) {
                // Destroy previous chart if exists
                if (trafficChart) {
                    trafficChart.destroy();
                }
                
                // Create new chart
                const ctx = document.getElementById('trafficDistributionChart').getContext('2d');
                trafficChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: colors,
                            borderColor: colors.map(c => c.replace('0.7', '1')),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    boxWidth: 12,
                                    padding: 15
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.raw.toFixed(1) + '%';
                                        return ' ' + label + ': ' + value;
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            function loadHistory() {
                fetch('/history')
                    .then(response => response.json())
                    .then(data => {
                        const historyTable = document.querySelector('#historyTable tbody');
                        historyTable.innerHTML = '';
                        
                        const emptyHistoryMessage = document.getElementById('emptyHistoryMessage');
                        
                        if (data.length === 0) {
                            emptyHistoryMessage.classList.remove('hidden');
                            return;
                        }
                        
                        emptyHistoryMessage.classList.add('hidden');
                        
                        data.forEach(task => {
                            const row = document.createElement('tr');
                            
                            // File name cell
                            const fileCell = document.createElement('td');
                            fileCell.className = 'py-3 px-4';
                            fileCell.textContent = task.filename;
                            
                            // Date cell
                            const dateCell = document.createElement('td');
                            dateCell.className = 'py-3 px-4 text-gray-500';
                            dateCell.textContent = task.created_at;
                            
                            // Status cell
                            const statusCell = document.createElement('td');
                            statusCell.className = 'py-3 px-4';
                            
                            const statusBadge = document.createElement('span');
                            statusBadge.className = `status-badge status-${task.status}`;
                            statusBadge.textContent = capitalizeFirstLetter(task.status);
                            
                            statusCell.appendChild(statusBadge);
                            
                            // Actions cell
                            const actionsCell = document.createElement('td');
                            actionsCell.className = 'py-3 px-4';
                            
                            const viewBtn = document.createElement('button');
                            viewBtn.className = 'text-blue-600 hover:text-blue-800 mr-3';
                            viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
                            viewBtn.title = 'View Results';
                            viewBtn.disabled = task.status !== 'completed';
                            
                            if (task.status === 'completed') {
                                viewBtn.addEventListener('click', function() {
                                    loadResult(task.id);
                                });
                            } else {
                                viewBtn.className += ' opacity-50 cursor-not-allowed';
                            }
                            
                            actionsCell.appendChild(viewBtn);
                            
                            // Add cells to row
                            row.appendChild(fileCell);
                            row.appendChild(dateCell);
                            row.appendChild(statusCell);
                            row.appendChild(actionsCell);
                            
                            // Add row to table
                            historyTable.appendChild(row);
                        });
                    })
                    .catch(error => {
                        console.error('Error:', error);
                    });
            }
            
            function clearHistory() {
                if (!confirm('Are you sure you want to clear the analysis history?')) {
                    return;
                }
                
                fetch('/clear_history', {
                    method: 'POST'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        loadHistory();
                    } else {
                        alert('Failed to clear history: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An error occurred while clearing history.');
                });
            }
            
            function checkModelStatus() {
                fetch('/check_model')
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'ready') {
                            modelStatus.textContent = 'Model Ready';
                            modelStatus.className = 'text-sm text-green-500';
                        } else {
                            modelStatus.innerHTML = 'Model Not Ready <i class="fas fa-exclamation-triangle ml-1"></i>';
                            modelStatus.className = 'text-sm text-yellow-500';
                            alert('Model files are missing. Please run train.py first to train the model.');
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        modelStatus.textContent = 'Model Status Unknown';
                        modelStatus.className = 'text-sm text-red-500';
                    });
            }
            
            function showSection(sectionId) {
                // Update active nav link
                navLinks.forEach(link => {
                    if (link.getAttribute('data-target') === sectionId) {
                        link.classList.add('active');
                    } else {
                        link.classList.remove('active');
                    }
                });
                
                // Show selected section, hide others
                pageSections.forEach(section => {
                    if (section.id === sectionId) {
                        section.classList.remove('hidden');
                    } else {
                        section.classList.add('hidden');
                    }
                });
            }
            
            function capitalizeFirstLetter(string) {
                return string.charAt(0).toUpperCase() + string.slice(1);
            }
        });
    </script>
</body>
</html>